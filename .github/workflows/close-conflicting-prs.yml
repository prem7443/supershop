name: Auto-Close PRs with Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  close-conflicted-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check for merge conflicts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No PR found in context.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;

            // Try up to 5 times to get mergeable state
            let attempts = 0;
            let mergeable = null;

            while (mergeable === null && attempts < 5) {
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });

              mergeable = prData.mergeable;
              if (mergeable === null) {
                console.log(`Attempt ${attempts + 1}: mergeable still null. Retrying...`);
                await new Promise(resolve => setTimeout(resolve, 3000));
              }

              attempts++;
            }

            if (mergeable === false) {
              console.log(`‚ùå PR #${pull_number} has conflicts. Closing.`);

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "üö´ This pull request has merge conflicts and has been closed automatically. Please resolve the conflicts and open a new PR."
              });

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number,
                state: 'closed'
              });
            } else if (mergeable === true) {
              console.log(`‚úÖ PR #${pull_number} is clean and mergeable.`);
            } else {
              console.log(`‚ö†Ô∏è Still couldn't determine mergeability for PR #${pull_number}.`);
            }
